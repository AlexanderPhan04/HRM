name: HRM System CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================
  # JOB 1: Code Quality & Linting
  # ============================================
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install ESLint
        run: |
          npm init -y
          npm install eslint --save-dev
          npm install eslint-plugin-import --save-dev

      - name: Lint JavaScript files
        run: npx eslint public/assets/js/**/*.js --fix-dry-run || true
        continue-on-error: true

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: pdo, pdo_mysql, mbstring
          coverage: none

      - name: Install PHP CodeSniffer
        run: |
          composer require --dev squizlabs/php_codesniffer

      - name: Lint PHP files
        run: vendor/bin/phpcs --standard=PSR12 app/ public/api.php || true
        continue-on-error: true

  # ============================================
  # JOB 2: Database Schema Validation
  # ============================================
  database-validation:
    name: Database Schema Validation
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: hrm_system_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for MySQL
        run: |
          until mysqladmin ping -h 127.0.0.1 -P 3306 -u root -ptest_password; do
            echo "Waiting for MySQL..."
            sleep 2
          done

      - name: Import database schema
        run: |
          mysql -h 127.0.0.1 -P 3306 -u root -ptest_password hrm_system_test < database/migrations/001_initial_schema.sql

      - name: Validate schema
        run: |
          mysql -h 127.0.0.1 -P 3306 -u root -ptest_password hrm_system_test -e "SHOW TABLES;"
          mysql -h 127.0.0.1 -P 3306 -u root -ptest_password hrm_system_test -e "DESCRIBE employees;"
          mysql -h 127.0.0.1 -P 3306 -u root -ptest_password hrm_system_test -e "SELECT COUNT(*) FROM users;"

  # ============================================
  # JOB 3: PHP Backend Tests
  # ============================================
  backend-tests:
    name: Backend API Tests
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation]

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: hrm_system_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: pdo, pdo_mysql, mbstring
          coverage: xdebug

      - name: Import database schema
        run: |
          mysql -h 127.0.0.1 -P 3306 -u root -ptest_password hrm_system_test < database/migrations/001_initial_schema.sql

      - name: Create test config
        run: |
          mkdir -p tests
          cat > tests/test_config.php << 'EOF'
          <?php
          define('DB_HOST', '127.0.0.1');
          define('DB_NAME', 'hrm_system_test');
          define('DB_USER', 'root');
          define('DB_PASS', 'test_password');
          define('BASE_PATH', __DIR__ . '/..');
          define('APP_PATH', BASE_PATH . '/app');
          define('CONFIG_PATH', APP_PATH . '/Config');
          define('CONTROLLER_PATH', APP_PATH . '/Controllers');
          define('MODEL_PATH', APP_PATH . '/Models');
          EOF

      - name: Install PHPUnit
        run: composer require --dev phpunit/phpunit

      - name: Run API Tests
        run: |
          echo "API tests would run here"
          echo "Testing Employee endpoints, Department endpoints, etc."
        continue-on-error: true

  # ============================================
  # JOB 4: Frontend JavaScript Tests
  # ============================================
  frontend-tests:
    name: Frontend JavaScript Tests
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm init -y
          npm install --save-dev jest @testing-library/dom

      - name: Run JavaScript tests
        run: |
          echo "JavaScript unit tests would run here"
          echo "Testing modules: authModule, employeeDbModule, etc."
        continue-on-error: true

  # ============================================
  # JOB 5: Security Scan
  # ============================================
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"
        continue-on-error: true

      - name: Check for SQL Injection vulnerabilities
        run: |
          echo "Checking PHP files for potential SQL injection..."
          grep -r "mysql_query\|mysqli_query" app/ || echo "No dangerous MySQL queries found"
          grep -r "\$_GET\|\$_POST" app/ | grep -v "prepare\|bindParam" || echo "Input sanitization check passed"

  # ============================================
  # JOB 6: Build & Package
  # ============================================
  build:
    name: Build & Package Application
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, security-scan]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          mkdir -p dist

          # Copy application files
          cp -r public dist/
          cp -r app dist/
          cp -r database dist/
          cp README.md dist/

          # Create .env.example
          cat > dist/.env.example << 'EOF'
          DB_HOST=localhost
          DB_NAME=hrm_system
          DB_USER=root
          DB_PASS=your_password_here
          APP_ENV=production
          APP_DEBUG=false
          EOF

          # Create version file
          echo "Build: $GITHUB_SHA" > dist/version.txt
          echo "Date: $(date)" >> dist/version.txt

          # Create deployment instructions
          cat > dist/DEPLOYMENT.md << 'EOF'
          # Deployment Instructions

          ## Prerequisites
          - PHP 8.4+
          - MySQL 8.0+
          - Web server (Apache/Nginx)

          ## Steps
          1. Extract files to web server directory
          2. Import database: `mysql -u root -p < database/migrations/001_initial_schema.sql`
          3. Copy `.env.example` to `app/Config/Database.php` and configure
          4. Set permissions: `chmod 755 public/` and `chmod 644 public/.htaccess`
          5. Access application via browser
          6. Login with: admin / admin123

          ## Post-Deployment
          - Change default admin password
          - Configure backup schedule
          - Monitor error logs
          EOF

      - name: Create deployment archive
        run: |
          cd dist
          tar -czf ../hrm-system-${{ github.sha }}.tar.gz .
          cd ..
          ls -lh hrm-system-*.tar.gz

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: hrm-deployment-package
          path: hrm-system-*.tar.gz
          retention-days: 30

  # ============================================
  # JOB 7: Deploy to Staging (Auto)
  # ============================================
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://hrm-staging.example.com

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: hrm-deployment-package

      - name: Deploy to staging server
        run: |
          echo "Deploying to staging environment..."
          echo "Server: staging.example.com"
          echo "Path: /var/www/hrm-staging"
          # Real deployment would use SSH/FTP here
          # scp hrm-system-*.tar.gz user@staging.example.com:/var/www/
          # ssh user@staging.example.com 'cd /var/www && tar -xzf hrm-system-*.tar.gz'

      - name: Run database migrations
        run: |
          echo "Running database migrations on staging..."
          # ssh user@staging.example.com 'mysql -u root -p < /var/www/hrm-staging/database/migrations/001_initial_schema.sql'

      - name: Clear application cache
        run: |
          echo "Clearing staging cache..."
          # ssh user@staging.example.com 'rm -rf /var/www/hrm-staging/cache/*'

      - name: Health check
        run: |
          echo "Running health check on staging..."
          # curl -f https://hrm-staging.example.com/api/health || exit 1

  # ============================================
  # JOB 8: Deploy to Production (Manual Approval)
  # ============================================
  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://hrm.example.com

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: hrm-deployment-package

      - name: Backup production database
        run: |
          echo "Creating production database backup..."
          # ssh user@prod.example.com 'mysqldump -u root -p hrm_system > /backups/hrm_$(date +%Y%m%d_%H%M%S).sql'

      - name: Deploy to production server
        run: |
          echo "Deploying to production environment..."
          echo "Server: prod.example.com"
          echo "Path: /var/www/hrm-production"
          # scp hrm-system-*.tar.gz user@prod.example.com:/var/www/
          # ssh user@prod.example.com 'cd /var/www && tar -xzf hrm-system-*.tar.gz'

      - name: Run database migrations
        run: |
          echo "Running database migrations on production..."
          # ssh user@prod.example.com 'mysql -u root -p hrm_system < /var/www/hrm-production/database/migrations/001_initial_schema.sql'

      - name: Clear application cache
        run: |
          echo "Clearing production cache..."
          # ssh user@prod.example.com 'rm -rf /var/www/hrm-production/cache/*'

      - name: Health check
        run: |
          echo "Running health check on production..."
          # curl -f https://hrm.example.com/api/health || exit 1

      - name: Notify team
        run: |
          echo "Sending deployment notification..."
          echo "âœ… HRM System deployed to production successfully!"
          echo "Version: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Time: $(date)"

  # ============================================
  # JOB 9: Performance Testing (Post-Deploy)
  # ============================================
  performance-test:
    name: Performance & Load Testing
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install k6 (Load Testing Tool)
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6 || echo "k6 installation skipped"

      - name: Run load tests
        run: |
          echo "Running load tests on staging environment..."
          echo "Testing API endpoints under load..."
        continue-on-error: true

  # ============================================
  # JOB 10: Notification
  # ============================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()

    steps:
      - name: Pipeline Status
        run: |
          echo "================================================"
          echo "        HRM SYSTEM CI/CD PIPELINE COMPLETE      "
          echo "================================================"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Status: ${{ job.status }}"
          echo "================================================"
